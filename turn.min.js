/* turn.js | turnjs.com | (C) 2012 Emmanuel Garcia | MIT License | (mod by ajar) */
!function(p){function i(t,a,e,r){return{css:{position:"absolute",top:t,left:a,"backface-visibility":"hidden",overflow:r||"hidden","z-index":e||"auto"}}}function h(t,a,e,r,i){var n=1-i,s=n*n*n,o=i*i*i;return D(Math.round(s*t.x+3*i*n*n*a.x+3*i*i*n*e.x+o*r.x),Math.round(s*t.y+3*i*n*n*a.y+3*i*i*n*e.y+o*r.y))}function k(t,a,e){return g&&e?" translate3d("+t+"px,"+a+"px, 0px) ":" translate("+t+"px, "+a+"px) "}function z(t){return" rotate("+t+"deg) "}function l(t,a){return Object.prototype.hasOwnProperty.call(a,t)}function W(t,a,e,r,i){var n=[];if("-webkit-"==f){for(c=0;c<i;c++)n.push("color-stop("+r[c][0]+", "+r[c][1]+")");t.css({"background-image":"-webkit-gradient(linear, "+a.x+"% "+a.y+"%,  "+e.x+"% "+e.y+"%, "+n.join(",")+" )"})}else{a={x:a.x/100*t.width(),y:a.y/100*t.height()};for(var s=(e={x:e.x/100*t.width(),y:e.y/100*t.height()}).x-a.x,o=e.y-a.y,p=Math.atan2(o,s),h=p-Math.PI/2,l=Math.abs(t.width()*Math.sin(h))+Math.abs(t.height()*Math.cos(h)),g=Math.sqrt(o*o+s*s),o=D(e.x<a.x?t.width():0,e.y<a.y?t.height():0),s=Math.tan(p),e=-1/s,s=(e*o.x-o.y-s*a.x+a.y)/(e-s),o=e*s-e*o.x+o.y,d=Math.sqrt(Math.pow(s-a.x,2)+Math.pow(o-a.y,2)),c=0;c<i;c++)n.push(" "+r[c][1]+" "+100*(d+g*r[c][0])/l+"%");t.css({"background-image":f+"linear-gradient("+-p+"rad,"+n.join(",")+")"})}}function e(t,a,e){if(e[0]&&"object"!=typeof e[0]){if(a[e[0]])return a[e[0]].apply(t,Array.prototype.slice.call(e,1));throw e[0]+" is an invalid value"}return a.init.apply(t,e)}var g,f="",F=Math.PI,A=F/2,t=(/iPad|iPhone|iPod/.test(navigator.platform)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints)&&!window.MSStream,a=-1<navigator.userAgent.toLowerCase().indexOf("android"),d="ontouchstart"in document.documentElement&&((window.PointerEvent?navigator.userAgent.match(/Windows Phone/i):0)||t||a),c=d?{start:"touchstart",move:"touchmove",end:"touchend"}:{start:"mousedown",move:"mousemove",end:"mouseup"},u={backward:["bl","tl"],forward:["br","tr"],all:["tl","bl","tr","br"]},r=["single","double"],v={page:1,gradients:!0,duration:600,acceleration:!0,display:"double",cover:!0,when:null},n={folding:null,corners:"forward",cornerSize:75,gradients:!0,duration:600,acceleration:!0},w={0:{top:0,left:0,right:"auto",bottom:"auto"},1:{top:0,right:0,left:"auto",bottom:"auto"}},D=function(t,a){return{x:t,y:a}},s={init:function(t){void 0===g&&(g="WebKitCSSMatrix"in window||"MozPerspective"in document.body.style,f=function(){for(var t=["Moz","Webkit","Khtml","O","ms"],a=t.length,e="";a--;)t[a]+"Transform"in document.body.style&&(e="-"+t[a].toLowerCase()+"-");return e}());var a,e=this.data(),r=this.children(),i="rtl"===e.dir;e.rtl=t.rtl=i,u={backward:i?["br","tr"]:["bl","tl"],forward:i?["bl","tl"]:["br","tr"],all:["tl","bl","tr","br"]};var n,s,o={left:{top:0,left:0,right:"auto",bottom:"auto"},right:{top:0,right:0,left:"auto",bottom:"auto"}};if(w={0:i?o.right:o.left,1:i?o.left:o.right},t=p.extend({width:this.width(),height:this.height()},v,t),e.opts=t,e.pageObjs={},e.pages={},e.pageWrap={},e.pagePlace={},e.pageMv=[],e.totalPages=t.pages||0,t.when)for(a in t.when)l(a,t.when)&&this.on(a,t.when[a]);for(this.css({position:"relative",width:t.width,height:t.height}),this.turn("display",t.display),g&&!d&&t.acceleration&&this.transform(k(0,0,!0)),a=0;a<r.length;a++)this.turn("addPage",r[a],a+1);return this.turn("page",t.page),u=p.extend({},u,t.corners),p(this).on(c.start,function(a){if(s=!1,d&&(n=setTimeout(function(){for(var t in e.pages)l(t,e.pages)&&(s=!0,T._eventMove.call(e.pages[t],a,!0))},200)),!p(a.target).is("a, a *, button"))for(var t in e.pages)if(l(t,e.pages)&&!1===T._eventStart.call(e.pages[t],a))return!1}),p(document).on(c.move,function(t){for(var a in s=!1,clearTimeout(n),e.pages)l(a,e.pages)&&T._eventMove.call(e.pages[a],t)}).on(c.end,function(t){if(!s||!d)for(var a in clearTimeout(n),e.pages)l(a,e.pages)&&T._eventEnd.call(e.pages[a],t)}),e.done=!0,this},addPage:function(t,a){var e=!1,r=this.data(),i=r.totalPages+1;if(a){if(a==i)a=i,e=!0;else if(i<a)throw new Error('It is impossible to add the page "'+a+'", the maximum value is: "'+i+'"')}else a=i,e=!0;return 1<=a&&a<=i&&(r.done&&this.turn("stop"),a in r.pageObjs&&s._movePages.call(this,a,1),e&&(r.totalPages=i),r.pageObjs[a]=p(t).addClass("turn-page p"+a),s._addPage.call(this,a),r.done&&this.turn("update"),s._removeFromDOM.call(this)),this},_addPage:function(t){var a,e,r=this.data(),i=r.pageObjs[t];i&&(s._necessPage.call(this,t)?(r.pageWrap[t]||(e="double"==r.display?this.width()/2:this.width(),a=this.height(),i.css({width:e,height:a}),r.pagePlace[t]=t,r.pageWrap[t]=p("<div/>",{class:"turn-page-wrapper",page:t,css:{position:"absolute",overflow:"hidden",width:e,height:a}}).css(w["double"==r.display?r.opts.cover?t%2:(t+1)%2:0]),this.append(r.pageWrap[t]),r.pageWrap[t].prepend(r.pageObjs[t])),t&&1!=s._setPageLoc.call(this,t)||s._makeFlip.call(this,t),"double"===r.display?i.find(".turn-page-gutter").length||0<(e=s._view.call(this,t))[0]&&e[1]<=r.totalPages&&(a=!r.opts.cover&&!(t%2)||r.opts.cover&&t%2,r.opts.rtl&&(a=!a),e=p("<div/>",{class:"turn-page-gutter",css:{position:"absolute","pointer-events":"none",width:30,height:"100%",zIndex:1}}).css(a?{left:0}:{right:0}),W(e,{x:100,y:0},{x:0,y:0},a?[[0,"rgba(0,0,0,0)"],[1,"rgba(0,0,0,0.1)"]]:[[0,"rgba(0,0,0,0.1)"],[1,"rgba(0,0,0,0)"]],2),i.append(e)):p(".turn-page-gutter").remove()):(r.pagePlace[t]=0,r.pageObjs[t]&&r.pageObjs[t].remove()))},hasPage:function(t){return t in this.data().pageObjs},_makeFlip:function(t){var a,e,r=this.data();return r.pages[t]||r.pagePlace[t]!=t||(a="single"==r.display,e=r.opts.cover?t%2:(t+1)%2,r.pages[t]=r.pageObjs[t].css({width:a?this.width():this.width()/2,height:this.height()}).flip({page:t,next:(!a||t!==r.totalPages)&&(e||a)?t+1:t-1,turn:this,duration:r.opts.duration,acceleration:r.opts.acceleration,corners:a?"all":e?"forward":"backward",backGradient:r.opts.gradients,frontGradient:r.opts.gradients}).flip("disable",r.disabled).on("pressed",s._pressed).on("released",s._released).on("start",s._start).on("end",s._end).on("flip",s._flip)),r.pages[t]},_makeRange:function(){this.data();for(var t=this.turn("range"),a=t[0];a<=t[1];a++)s._addPage.call(this,a)},range:function(t){var a,e,r=this.data();t=t||r.tpage||r.page;var i=s._view.call(this,t);if(t<1||t>r.totalPages)throw new Error('"'+t+'" is not a page for range');return i[1]=i[1]||i[0],1<=i[0]&&i[1]<=r.totalPages?(t=Math.floor(498.5),r.totalPages-i[1]>i[0]?e=2*t-(a=Math.min(i[0]-1,t)):a=2*t-(e=Math.min(r.totalPages-i[1],t))):e=a=998,[Math.max(1,i[0]-a),Math.min(r.totalPages,i[1]+e)]},_necessPage:function(t){if(0===t)return!0;var a=this.turn("range");return t>=a[0]&&t<=a[1]},_removeFromDOM:function(){var t,a=this.data();for(t in a.pageWrap)l(t,a.pageWrap)&&!s._necessPage.call(this,t)&&s._removePageFromDOM.call(this,t)},_removePageFromDOM:function(t){var a=this.data();a.pages[t]&&(a.pages[t].remove(),delete a.pages[t]),a.pageObjs[t]&&a.pageObjs[t].remove(),a.pageWrap[t]&&(a.pageWrap[t].remove(),delete a.pageWrap[t]),delete a.pagePlace[t]},removePage:function(t){var a=this.data();return a.pageObjs[t]&&(this.turn("stop"),s._removePageFromDOM.call(this,t),delete a.pageObjs[t]),this},_movePages:function(t,r){function a(t){var a=t+r,e=i.opts.cover?a%2:(a+1)%2;i.pageObjs[t]&&(i.pageObjs[a]=i.pageObjs[t].removeClass("page"+t).addClass("page"+a)),i.pagePlace[t]&&i.pageWrap[t]&&(i.pagePlace[a]=a,i.pageWrap[a]=i.pageWrap[t].css(w[n?0:e]).attr("page",a),i.pages[t]&&(i.pages[a]=i.pages[t].flip("options",{page:a,next:n||e?a+1:a-1,corners:n?"all":e?"forward":"backward"})),r&&(delete i.pages[t],delete i.pagePlace[t],delete i.pageObjs[t],delete i.pageWrap[t],delete i.pageObjs[t]))}var e,i=this.data(),n="single"==i.display;if(0<r)for(e=i.totalPages;t<=e;e--)a(e);else for(e=t;e<=i.totalPages;e++)a(e)},display:function(t){var a=this.data(),e=a.display;if(t){if(-1==p.inArray(t,r))throw new Error('"'+t+'" is not a value for display');return"single"==t?a.pageObjs[0]||(this.turn("stop").css({overflow:"hidden"}),a.pageObjs[0]=p("<div />",{class:"turn-page p-temporal"}).css({width:this.width(),height:this.height()}).appendTo(this)):a.pageObjs[0]&&(this.turn("stop").css({overflow:""}),a.pageObjs[0].remove(),delete a.pageObjs[0]),a.display=t,e&&(t=this.turn("size"),s._movePages.call(this,1,0),this.turn("size",t.width,t.height).turn("update")),this}return e},animating:function(){return 0<this.data().pageMv.length},disable:function(t){var a,e=this.data(),r=this.turn("view");for(a in e.disabled=void 0===t||!0===t,e.pages)l(a,e.pages)&&e.pages[a].flip("disable",!!t&&p.inArray(a,r));return this},size:function(t,a){if(t&&a){var e,r=this.data(),i="double"==r.display?t/2:t;for(e in this.css({width:t,height:a}),r.pageObjs[0]&&r.pageObjs[0].css({width:i,height:a}),r.pageWrap)l(e,r.pageWrap)&&(r.pageObjs[e].css({width:i,height:a}),r.pageWrap[e].css({width:i,height:a}),r.pages[e]&&r.pages[e].css({width:i,height:a}));return s._makeRange.call(this),this.turn("resize"),this}return{width:this.width(),height:this.height()}},resize:function(){var t,a=this.data();for(a.pages[0]&&(a.pageWrap[0].css({left:-this.width()}),a.pages[0].flip("resize",!0)),t=1;t<=a.totalPages;t++)a.pages[t]&&a.pages[t].flip("resize",!0)},_removeMv:function(t){for(var a=this.data(),e=0;e<a.pageMv.length;e++)if(a.pageMv[e]==t)return a.pageMv.splice(e,1),!0;return!1},_addMv:function(t){var a=this.data();s._removeMv.call(this,t),a.pageMv.push(t)},_view:function(t){var a=this.data();return t=t||a.page,"double"!=a.display||a.opts.cover?"double"==a.display?t%2?[t-1,t]:[t,t+1]:[t]:(t+1)%2?[t-1,t]:[t,t+1]},view:function(t){var a=this.data(),t=s._view.call(this,t);return"double"==a.display?[0<t[0]?t[0]:0,t[1]<=a.totalPages?t[1]:0]:[0<t[0]&&t[0]<=a.totalPages?t[0]:0]},stop:function(t){var a,e,r=this.data(),i=r.pageMv;for(a in r.pageMv=[],r.tpage&&(r.page=r.tpage,delete r.tpage),i)l(a,i)&&(e=r.pages[i[a]].data().f.opts,T._moveFoldingPage.call(r.pages[i[a]],null),r.pages[i[a]].flip("hideFoldedPage"),r.pagePlace[e.next]=e.next,e.force&&(e.next=e.page%2==0?e.page-1:e.page+1,delete e.force));return this.turn("update"),this},pages:function(t){var a=this.data();if(t){if(t<a.totalPages){for(var e=t+1;e<=a.totalPages;e++)this.turn("removePage",e);this.turn("page")>t&&this.turn("page",t)}return a.totalPages=t,this}return a.totalPages},_fitPage:function(t,a){var e=this.data(),r=this.turn("view",t);e.page!=t&&(this.trigger("turning",[t,r]),-1!=p.inArray(1,r)&&this.trigger("first"),-1!=p.inArray(e.totalPages,r)&&this.trigger("last")),e.pageObjs[t]&&(e.tpage=t,this.turn("stop",a),s._removeFromDOM.call(this),s._makeRange.call(this),this.trigger("turned",[t,r]))},_turnPage:function(t){var a,e,r=this.data(),i=this.turn("view"),n=this.turn("view",t);r.page!=t&&(this.trigger("turning",[t,n]),-1!=p.inArray(1,n)&&this.trigger("first"),-1!=p.inArray(r.totalPages,n)&&this.trigger("last")),r.pageObjs[t]&&(r.tpage=t,this.turn("stop"),s._makeRange.call(this),"single"==r.display?(a=i[0],e=n[0]):i[1]&&t>i[1]?(a=i[1],e=n[0]):i[0]&&t<i[0]&&(a=i[0],e=n[1]),r.pages[a]&&(t=r.pages[a].data().f.opts,r.tpage=e,t.next!=e&&(t.next=e,r.pagePlace[e]=t.page,t.force=!0),"single"==r.display?r.pages[a].flip("turnPage",(n[0]>i[0]?u.forward:u.backward)[0]):r.pages[a].flip("turnPage")))},page:function(t){t=parseInt(t,10);var a=this.data();return 0<t&&t<=a.totalPages?((a.done&&-1==p.inArray(t,this.turn("view"))?s._turnPage:s._fitPage).call(this,t),this):a.page},next:function(){var t=this.data();return this.turn("page",s._view.call(this,t.page).pop()+1)},previous:function(){var t=this.data();return this.turn("page",s._view.call(this,t.page).shift()-1)},_addMotionPage:function(){var t=p(this).data().f.opts,a=t.turn,e=a.data();t.pageMv=t.page,s._addMv.call(a,t.pageMv),e.pagePlace[t.next]=t.page,a.turn("update")},_start:function(t,a,e){var r=a.turn.data(),i=p.Event("start");t.stopPropagation(),a.turn.trigger(i,[a,e]),i.isDefaultPrevented()?t.preventDefault():("single"==r.display&&(e=u.backward[0].charAt(1)==e.charAt(1),1==a.page&&e||a.page==r.totalPages&&!e?t.preventDefault():e?(a.next=a.next<a.page?a.next:a.page-1,a.force=!0):a.next=a.next>a.page?a.next:a.page+1),s._addMotionPage.call(this))},_end:function(t,a){var e=p(this).data().f.opts,r=e.turn,i=r.data();t.stopPropagation(),a||i.tpage?i.tpage!=e.next&&i.tpage!=e.page||(delete i.tpage,s._fitPage.call(r,i.tpage||e.next,!0)):(r.turn("update"),p(".turn-page-wrapper:not(:has(*))").css("z-index","-1"))},_pressed:function(){var t,a=p(this).data().f,e=a.opts.turn.data().pages;for(t in e)t!=a.opts.page&&e[t].flip("disable",!0);return a.time=(new Date).getTime()},_released:function(t,a){var e=p(this),r=e.data().f;t.stopPropagation();var i=e.width(),n=(a.corner,r.opts),s=n.turn.data(),n=n.page>n.next;s.rtl&&(n=!n),((new Date).getTime()-r.time<200||(n?a.x>.5*i:a.x<.5*i))&&(t.preventDefault(),r.opts.turn.data().tpage=r.opts.next,r.opts.turn.turn("update"),p(e).flip("turnPage"))},_flip:function(){var t=p(this).data().f.opts;t.turn.trigger("turn",[t.next])},calculateZ:function(t){function a(t){(t=n.turn("view",t))[0]&&(h.pageV[t[0]]=!0),t[1]&&(h.pageV[t[1]]=!0)}for(var e,r,i,n=this,s=this.data(),o=this.turn("view"),p=o[0]||o[1],h={pageZ:{},partZ:{},pageV:{}},l=0;l<t.length;l++)i=t[l],e=s.pages[i].data().f.opts.next,r=s.pagePlace[i],a(i),a(e),i=s.pagePlace[e]==e?e:i,h.pageZ[i]=s.totalPages-Math.abs(p-i),h.partZ[r]=2*s.totalPages+Math.abs(p-i);return h},update:function(){var t,a,e=this.data();if(e.pageMv.length&&0!==e.pageMv[0]){var r=this.turn("calculateZ",e.pageMv),i=this.turn("view",e.tpage);for(t in e.pagePlace[i[0]]==i[0]?i[0]:e.pagePlace[i[1]]==i[1]&&i[1],e.pageWrap)l(t,e.pageWrap)&&(e.pageWrap[t].css({display:r.pageV[t]?"":"none","z-index":r.pageZ[t]||0}),e.pages[t]&&(e.pages[t].flip("z",r.partZ[t]||null),r.pageV[t]&&e.pages[t].flip("resize"),e.tpage&&e.pages[t].flip("disable",!0)))}else for(t in e.pageWrap)l(t,e.pageWrap)&&(a=s._setPageLoc.call(this,t),e.pages[t]&&e.pages[t].flip("disable",e.disabled||1!=a).flip("z",null))},_setPageLoc:function(t){var a=this.data(),e=this.turn("view");return t==e[0]||t==e[1]?(a.pageWrap[t].css({"z-index":a.totalPages,display:""}),1):"single"==a.display&&t==e[0]+1||"double"==a.display&&t==e[0]-2||t==e[1]+2&&0!=e[1]?(a.pageWrap[t].css({"z-index":a.totalPages-1,display:""}),2):(a.pageWrap[t].css({"z-index":0,display:"none"}),0)}},T={init:function(t){return t.gradients&&(t.frontGradient=!0,t.backGradient=!0),this.data({f:{}}),this.flip("options",t),T._addPageWrapper.call(this),this},setData:function(t){var a=this.data();return a.f=p.extend(a.f,t),this},options:function(t){var a=this.data().f;return t?(T.setData.call(this,{opts:p.extend({},a.opts||n,t)}),this):a.opts},z:function(t){var a=this.data().f;return a.opts["z-index"]=t,a.fwrapper.css({"z-index":t||parseInt(a.parent.css("z-index"),10)||0}),this},_cAllowed:function(){return u[this.data().f.opts.corners]||this.data().f.opts.corners},_cornerActivated:function(t){if(void 0===t.originalEvent)return!1;t=d?t.originalEvent.touches:[t];var a=this.data().f,e=a.parent.offset(),r=this.width(),i=this.height(),t={x:Math.max(0,t[0].pageX-e.left),y:Math.max(0,t[0].pageY-e.top)},e=a.opts.cornerSize,a=T._cAllowed.call(this);if(t.x<=0||t.y<=0||t.x>=r||t.y>=i)return!1;if(t.y<e)t.corner="t";else{if(!(t.y>=i-e))return!1;t.corner="b"}if(t.x<=e)t.corner+="l";else{if(!(t.x>=r-e))return!1;t.corner+="r"}return-1!=p.inArray(t.corner,a)&&t},_c:function(t,a){return{tl:D(a=a||0,a),tr:D(this.width()-a,a),bl:D(a,this.height()-a),br:D(this.width()-a,this.height()-a)}[t]},_c2:function(t){return{tl:D(2*this.width(),0),tr:D(-this.width(),0),bl:D(2*this.width(),this.height()),br:D(-this.width(),this.height())}[t]},_foldingPage:function(t){var a=this.data().f.opts;if(a.folding)return a.folding;if(a.turn){var e=a.turn.data();return"single"==e.display?e.pageObjs[a.next]?e.pageObjs[0]:null:e.pageObjs[a.next]}},_backGradient:function(){var t=this.data().f,a=t.opts.turn,a=t.opts.backGradient&&(!a||"single"==a.data().display||2!=t.opts.page&&t.opts.page!=a.data().totalPages-1);return a&&!t.bshadow&&(t.bshadow=p("<div/>",i(0,0,1)).css({position:"",width:this.width(),height:this.height()}).appendTo(t.parent)),a},resize:function(t){var a=this.data().f,e=this.width(),r=this.height(),i=Math.round(Math.sqrt(Math.pow(e,2)+Math.pow(r,2)));t&&(a.wrapper.css({width:i,height:i}),a.fwrapper.css({width:i,height:i}).children(":first-child").css({width:e,height:r}),a.fpage.css({width:r,height:e}),a.opts.frontGradient&&a.ashadow.css({width:r,height:e}),T._backGradient.call(this)&&a.bshadow.css({width:e,height:r})),a.parent.is(":visible")&&(a.fwrapper.css({top:a.parent.offset().top,left:a.parent.offset().left}),a.opts.turn&&a.fparent.css({top:-a.opts.turn.offset().top,left:-a.opts.turn.offset().left})),this.flip("z",a.opts["z-index"])},_addPageWrapper:function(){var t,a,e=this.data().f,r=this.parent();e.wrapper||(this.css("left"),this.css("top"),t=this.width(),a=this.height(),Math.round(Math.sqrt(Math.pow(t,2)+Math.pow(a,2))),e.parent=r,e.fparent=e.opts.turn?e.opts.turn.data().fparent:p("#turn-fwrappers"),e.fparent||((a=p("<div/>",{css:{"pointer-events":"none"}}).hide()).data().flips=0,e.opts.turn?(a.css(i(-e.opts.turn.offset().top,-e.opts.turn.offset().left,"auto","visible").css).appendTo(e.opts.turn),e.opts.turn.data().fparent=a):a.css(i(0,0,"auto","visible").css).attr("id","turn-fwrappers").appendTo(p("body")),e.fparent=a),this.css({position:"absolute",top:0,left:0,bottom:"auto",right:"auto"}),e.wrapper=p("<div/>",i(0,0,this.css("z-index"))).appendTo(r).prepend(this),e.fwrapper=p("<div/>",i(r.offset().top,r.offset().left)).hide().appendTo(e.fparent),e.fpage=p("<div/>",{css:{cursor:"default","background-color":"#fff"}}).appendTo(p("<div/>",i(0,0,0,"visible")).appendTo(e.fwrapper)),e.opts.frontGradient&&(e.ashadow=p("<div/>",i(0,0,1)).appendTo(e.fpage)),T.setData.call(this,e),T.resize.call(this,!0))},_fold:function(s){function t(t,a,e,r){var i=["0","auto"],n=(b-P)*e[0]/100,s=(x-P)*e[1]/100,i={left:i[a[0]],top:i[a[1]],right:i[a[2]],bottom:i[a[3]]},a=90!=r&&-90!=r?O?-1:1:0;e=e[0]+"% "+e[1]+"%",d.css(i).transform(z(r)+k(t.x+a,t.y,y),e),m.fpage.parent().css(i),m.wrapper.transform(k(-t.x+n-a,-t.y+s,y)+z(-r),e),m.fwrapper.transform(k(-t.x+u.x+n,-t.y+u.y+s,y)+z(-r),e),m.fpage.parent().transform(z(r)+k(t.x+v.x-u.x,t.y+v.y-u.y,y),e),m.opts.frontGradient&&W(m.ashadow,D(O?100:0,_?100:0),D(o.x,o.y),[[h,"rgba(0,0,0,0)"],[.8*(1-h)+h,"rgba(0,0,0,"+.2*g+")"],[1,"rgba(255,255,255,"+.2*g+")"]],3),T._backGradient.call(d)&&W(m.bshadow,D(O?0:100,_?0:100),D(p.x,p.y),[[.8,"rgba(0,0,0,0)"],[1,"rgba(0,0,0,"+.3*g+")"],[1,"rgba(0,0,0,0)"]],3)}var o,p,h,l,g,d=this,c=0,f=0,u=D(0,0),v=D(0,0),w=D(0,0),b=this.width(),x=this.height(),a=T._foldingPage.call(this),m=(Math.tan(f),this.data().f),y=m.opts.acceleration,P=m.wrapper.height(),M=T._c.call(this,s.corner),_="t"==s.corner.substr(0,1),O="l"==s.corner.substr(1,1),j=function(){var t,a=D(M.x?M.x-s.x:s.x,M.y?M.y-s.y:s.y),e=Math.atan2(a.y,a.x);c=(f=A-e)/F*180,t=D(O?b-a.x/2:s.x+a.x/2,a.y/2);var r=f-Math.atan2(t.y,t.x),r=Math.max(0,Math.sin(r)*Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)));if(w=D(r*Math.sin(f),r*Math.cos(f)),A<f&&(w.x=w.x+Math.abs(w.y*Math.tan(e)),w.y=0,Math.round(w.x*Math.tan(F-f))<x))return s.y=Math.sqrt(Math.pow(x,2)+2*t.x*a.x),_&&(s.y=x-s.y),j();A<f&&(n=F-f,i=P-x/Math.sin(n),u=D(Math.round(i*Math.cos(n)),Math.round(i*Math.sin(n))),O&&(u.x=-u.x),_&&(u.y=-u.y)),l=Math.round(w.y/Math.tan(f)+w.x);var a=b-l,i=a*Math.cos(2*f),n=a*Math.sin(2*f);v=D(Math.round(O?a-i:l+i),Math.round(_?n:x-n)),l=a*Math.sin(f);a=T._c2.call(d,s.corner),a=Math.sqrt(Math.pow(a.x-s.x,2)+Math.pow(a.y-s.y,2));return g=a<b?a/b:1,m.opts.frontGradient&&(h=100<l?(l-100)/l:0,o=D(l*Math.sin(A-f)/x*100,l*Math.cos(A-f)/b*100),_&&(o.y=100-o.y),O&&(o.x=100-o.x)),T._backGradient.call(d)&&(p=D(l*Math.sin(f)/b*100,l*Math.cos(f)/x*100),O||(p.x=100-p.x),_||(p.y=100-p.y)),w.x=Math.round(w.x),w.y=Math.round(w.y),!0};switch(s.corner){case"tl":s.x=Math.max(s.x,1),j(),t(w,[1,0,0,1],[100,0],c),m.fpage.transform(k(-x,-b,y)+z(90-2*c),"100% 100%"),a.transform(z(90)+k(0,-x,y),"0% 0%");break;case"tr":s.x=Math.min(s.x,b-1),j(),t(D(-w.x,w.y),[0,0,0,1],[0,0],-c),m.fpage.transform(k(0,-b,y)+z(2*c-90),"0% 100%"),a.transform(z(270)+k(-b,0,y),"0% 0%");break;case"bl":s.x=Math.max(s.x,1),j(),t(D(w.x,-w.y),[1,1,0,0],[100,100],-c),m.fpage.transform(k(-x,0,y)+z(2*c-90),"100% 0%"),a.transform(z(270)+k(-b,0,y),"0% 0%");break;case"br":s.x=Math.min(s.x,b-1),j(),t(D(-w.x,-w.y),[0,1,1,0],[0,100],c),m.fpage.transform(z(90-2*c),"0% 0%"),a.transform(z(90)+k(0,-x,y),"0% 0%")}m.point=s},_moveFoldingPage:function(t){var a=this.data().f,e=T._foldingPage.call(this);e&&(t?a.fpage.children()[a.ashadow?"1":"0"]||(T.setData.call(this,{backParent:e.parent()}),a.fpage.prepend(e)):a.backParent&&a.backParent.prepend(e))},_showFoldedPage:function(a,t){var e,r=T._foldingPage.call(this),i=this.data(),n=i.f;if(!n.point||n.point.corner!=a.corner){var s=p.Event("start");if(this.trigger(s,[n.opts,a.corner]),s.isDefaultPrevented())return!1}return!!r&&(t?(e=this,t=n.point&&n.point.corner==a.corner?n.point:T._c.call(this,a.corner,1),this.animatef({from:[t.x,t.y],to:[a.x,a.y],duration:500,frame:function(t){a.x=Math.round(t[0]),a.y=Math.round(t[1]),T._fold.call(e,a)}})):(T._fold.call(this,a),i.effect&&!i.effect.turning&&this.animatef(!1)),n.fwrapper.is(":visible")||(n.fparent.show().data().flips++,T._moveFoldingPage.call(this,!0),n.fwrapper.show(),n.bshadow&&n.bshadow.show()),!0)},hide:function(){var t=this.data().f,a=T._foldingPage.call(this);return 0==--t.fparent.data().flips&&t.fparent.hide(),this.css({left:0,top:0,right:"auto",bottom:"auto"}).transform("","0% 100%"),t.wrapper.transform("","0% 100%"),t.fwrapper.hide(),t.bshadow&&t.bshadow.hide(),a.transform("","0% 0%"),this},hideFoldedPage:function(t){var a,e,r,i,n,s,o=this.data().f;o.point&&(a=this,e=o.point,r=function(){o.point=null,a.flip("hide"),a.trigger("end",[!1])},t?(i=T._c.call(this,e.corner),t="t"==e.corner.substr(0,1)?Math.min(0,e.y-i.y)/2:Math.max(0,e.y-i.y)/2,n=D(e.x,e.y+t),s=D(i.x,i.y-t),this.animatef({from:0,to:1,frame:function(t){t=h(e,n,s,i,t);e.x=t.x,e.y=t.y,T._fold.call(a,e)},complete:r,duration:800,hiding:!0})):(this.animatef(!1),r()))},turnPage:function(a){var e=this,t=this.data().f;a={corner:t.corner?t.corner.corner:a||T._cAllowed.call(this)[0]};var r=t.point||T._c.call(this,a.corner,t.opts.turn?t.opts.turn.data().opts.elevation:0),i=T._c2.call(this,a.corner);this.trigger("flip").animatef({from:0,to:1,frame:function(t){t=h(r,r,i,i,t);a.x=t.x,a.y=t.y,T._showFoldedPage.call(e,a)},complete:function(){e.trigger("end",[!0])},duration:t.opts.duration,turning:!0}),t.corner=null},moving:function(){return"effect"in this.data()},isTurning:function(){return this.flip("moving")&&this.data().effect.turning},_eventStart:function(t){var a=this.data().f;if(!a.disabled&&!this.flip("isTurning")){if(a.corner=T._cornerActivated.call(this,t),a.corner&&T._foldingPage.call(this,a.corner))return T._moveFoldingPage.call(this,!0),this.trigger("pressed",[a.point]),!1;a.corner=null}},_eventMove:function(t,a){var e=this.data().f;e.disabled||(t=d&&!a?t.originalEvent.touches:[t],e.corner&&!a?(a=e.parent.offset(),e.corner.x=t[0].pageX-a.left,e.corner.y=t[0].pageY-a.top,T._showFoldedPage.call(this,e.corner)):!this.data().effect&&this.is(":visible")&&((t=T._cornerActivated.call(this,t[0]))?(e=T._c.call(this,t.corner,e.opts.cornerSize/2),t.x=e.x,t.y=e.y,T._showFoldedPage.call(this,t,!0)):T.hideFoldedPage.call(this,!0)))},_eventEnd:function(){var t,a=this.data().f;!a.disabled&&a.point&&(t=p.Event("released"),this.trigger(t,[a.point]),t.isDefaultPrevented()||T.hideFoldedPage.call(this,!0)),a.corner=null},disable:function(t){return T.setData.call(this,{disabled:t}),this}};p.extend(p.fn,{flip:function(t,a){return e(this,T,arguments)},turn:function(t){return e(this,s,arguments)},transform:function(t,a){var e={};return a&&(e[f+"transform-origin"]=a),e[f+"transform"]=t,this.css(e)},animatef:function(e){var r=this.data();if(r.effect&&clearInterval(r.effect.handle),e){e.to.length||(e.to=[e.to]),e.from.length||(e.from=[e.from]),e.easing||(e.easing=function(t,a,e,r,i){return r*Math.sqrt(1-(a=a/i-1)*a)+e});function t(){var t,a=[];for(p=Math.min(e.duration,p+o),t=0;t<n;t++)a.push(e.easing(1,p,e.from[t],i[t],e.duration));e.frame(1==n?a[0]:a),p==e.duration&&(clearInterval(r.effect.handle),delete r.effect,s.data(r),e.complete&&e.complete())}for(var i=[],n=e.to.length,s=this,o=e.fps||30,p=-o,a=0;a<n;a++)i.push(e.to[a]-e.from[a]);r.effect=e,r.effect.handle=setInterval(t,o),this.data(r),t()}else delete r.effect},peel:function(t){try{var a=t||u.forward[1],e=this.data(),r=e.pageObjs[e.page].flip("options").cornerSize,e=e.pageObjs[s._view.call(this,e.page).pop()],r=T._c.call(e,a,r/2);r.corner=a,e.flip("_showFoldedPage",r,!0)}catch(t){}}}),p.isTouch=d}(jQuery);